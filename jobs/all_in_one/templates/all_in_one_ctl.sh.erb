#!/bin/bash

job_dir=/var/vcap/jobs/all_in_one
run_dir=/var/vcap/sys/run/all_in_one
log_dir=/var/vcap/sys/log/all_in_one
package_dir=/var/vcap/packages/all_in_one
pidfile=$run_dir/all_in_one.pid

export PATH=$PWD/bin:$PATH

source /var/vcap/packages/pid_utils/pid_utils.sh

case $1 in
  start)
    log "Starting all_in_one..."
    pid_guard $pidfile "AllInOne"

    mkdir -p $run_dir
    chown vcap:vcap -R $run_dir
    mkdir -p $log_dir
    chown vcap:vcap -R $log_dir

    cd $package_dir

    $job_dir/bin/run >> $log_dir/all_in_one.log 2>&1

    log "Starting all_in_one... done"
    ;;

  stop)
    log "Stopping all_in_one..."
    kill_and_wait $pidfile 20
    log "Stopping all_in_one... done"
    rm $pidfile
    ;;

  *)
    echo "Usage: all_in_one_ctl {start|stop}"
    ;;

esac